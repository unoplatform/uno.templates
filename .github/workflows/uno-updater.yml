name: Update Uno Sdk

on:
  schedule:
    - cron: '0 */6 * * *'
  pull_request:
    branches:
      - main
    paths:
      - .github/workflows/uno-updater.yml
      - tools/Uno.Sdk.Updater/*
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to update'
        required: true
        default: 'main'

jobs:
  manifest-update:
    runs-on: windows-latest
    strategy:
      matrix:
        branch:
          - main
          - release/stable/5.3
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ matrix.branch }}
        fetch-depth: 0

    - name: Set target branch
      id: targetbranch
      run: |
        if [[ "${{ matrix.branch }}" == "main" ]]; then
          echo "::set-output name=targetbranch::sdk/update/dev"
        else
          versionNumber=$(echo "${{ matrix.branch }}" | cut -d'/' -f 3)
          echo "::set-output name=targetbranch::sdk/update/release/$versionNumber"
        fi
      shell: bash

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.300'

    - name: Setup GitVersion
      uses: gittools/actions/gitversion/setup@v1.1.1
      with:
        versionSpec: '5.10.3'

    - name: GitVersion
      id: gitversion
      uses: gittools/actions/gitversion/execute@v1.1.1
      with:
        useConfigFile: true
        configFilePath: build/gitversion.yml

    - name: Run Uno Sdk Updater
      run: dotnet run -c Release --project tools/Uno.Sdk.Updater

    - name: Create Pull Request
      if: github.event_name != 'pull_request'
      id: cpr
      uses: peter-evans/create-pull-request@6d6857d36972b65feb161a90e484f2984215f83e # v6.0.5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ steps.targetbranch.outputs.targetbranch }}
        commit-message: 'chore: Update Uno.Sdk'
        title: Uno.Sdk Update
        body: |
          This updates the Uno.Sdk to the latest available version. 
        labels: sdk-update
        draft: false

    - name: Enable Pull Request Automerge
      if: steps.cpr.outputs.pull-request-operation == 'created'
      uses: peter-evans/enable-pull-request-automerge@a660677d5469627102a1c1e11409dd063606628d # v3.0.0
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}

    #- name: Auto approve
    #  if: steps.cpr.outputs.pull-request-operation == 'created'
    #  run: gh pr review --approve "${{ steps.cpr.outputs.pull-request-number }}"
    #  env:
    #    GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
