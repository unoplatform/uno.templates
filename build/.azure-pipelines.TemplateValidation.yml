jobs:
- job: Packages_Validation

  pool:
    vmImage: 'windows-2022'

  variables:
    - name: UseDotNetNativeToolchain
      value: false

  steps:

  - template: templates/dotnet-install-windows.yml
    parameters:
      DotNetVersion: '7.0.400'

  - template: templates/dotnet-install-windows.yml
    parameters:
      DotNetVersion: '8.0.100-rc.1.23463.5'

  - powershell: |
      & dotnet workload install android ios macos maccatalyst --from-rollback-file https://maui.blob.core.windows.net/metadata/rollbacks/7.0.92.json --skip-sign-check
    displayName: Restore workloads .NET 7

  - powershell: |
      & dotnet workload install android ios macos maccatalyst --from-rollback-file https://maui.blob.core.windows.net/metadata/rollbacks/8.0.0-rc.1.9171.json --skip-sign-check
    displayName: Restore workloads .NET 8

  - task: DownloadBuildArtifacts@0
    inputs:
      artifactName: $(Build.DefinitionName)

  - script: |
        md $(Build.SourcesDirectory)\src\PackageCache
        copy "$(System.ArtifactsDirectory)\$(Build.DefinitionName)\*.nupkg" $(Build.SourcesDirectory)\src\PackageCache
    displayName: Copy Artifacts to PackageCache

  - script: dotnet new install "$(System.ArtifactsDirectory)\$(Build.DefinitionName)\Uno.Templates*.nupkg"
    displayName: Install Project Templates

  - powershell: |
        dotnet nuget add source -n nuget_local $(Build.SourcesDirectory)\src\PackageCache
        dotnet nuget add source -n uno_dev "https://pkgs.dev.azure.com/uno-platform/1dd81cbd-cb35-41de-a570-b0df3571a196/_packaging/unoplatformdev/nuget/v3/index.json"
        dotnet nuget add source -n net8 "https://pkgs.dev.azure.com/dnceng/public/_packaging/dotnet8/nuget/v3/index.json"
        dotnet nuget add source -n ApiLocal "https://api.nuget.org/v3/index.json"

    displayName: Add NuGet sources

  - template: templates/package-validation.yml
    parameters:
        templateArgs: ''
        projectName: 'DefaultArguments'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-preset blank'
        projectName: 'Blank'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-platforms gtk wpf linux-fb'
        projectName: 'SkiaOnlyHeads'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-platforms android ios maccatalyst'
        projectName: 'MobileOnlyHeads'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-preset blank -markup csharp'
        projectName: 'BlankMarkup'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-preset blank --cpm false'
        projectName: 'BlankNoCpm'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-presentation mvvm'
        projectName: 'MVVM'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '--cpm false'
        projectName: 'NoCentralPackageManagement'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-markup csharp'
        projectName: 'CSharpMarkup'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-di false'
        projectName: 'NoHosting'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-config false -loc false -http false -log none --navigation blank'
        projectName: 'HostingOnly'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-config false'
        projectName: 'NoConfiguration'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-loc false'
        projectName: 'NoLocalization'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-http false'
        projectName: 'NoHttp'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-log default'
        projectName: 'NoSerilog'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-server false'
        projectName: 'NoServer'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-server false -http false'
        projectName: 'NoServerNoHttp'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-tests none'
        projectName: 'NoTests'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '--navigation blank'
        projectName: 'FrameNavigation'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-tfm net8.0'
        projectName: 'Net8'
      # https://github.com/unoplatform/uno.templates/issues/22
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-preset blank -tfm net7.0 -platforms android -platforms ios -platforms maccatalyst -platforms macos -platforms windows -platforms wasm -platforms gtk -platforms wpf -platforms linux-fb -presentation mvvm -server false -tests none -vscode false -pwa false -di true -nav regions -log none -theme material'
        projectName: 'Issue22'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-preset=recommended -auth=custom'
        projectName: 'CustomAuthMvux'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-preset=recommended -presentation mvvm -auth=custom'
        projectName: 'CustomAuthMvvm'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-preset=recommended -auth=web'
        projectName: 'WebAuthMvux'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-preset=recommended -presentation mvvm -auth=web'
        projectName: 'WebAuthMvvm'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-preset=recommended -auth=oidc'
        projectName: 'OidcAuthMvux'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-preset=recommended -presentation mvvm -auth=oidc'
        projectName: 'OidcAuthMvvm'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-preset=recommended -auth=msal'
        projectName: 'MsalAuthMvux'
  - template: templates/package-validation.yml
    parameters:
        templateArgs: '-preset=recommended -presentation mvvm -auth=msal'
        projectName: 'MsalAuthMvvm'
  - template: templates/package-validation.yml
    parameters:
       templateArgs: '-preset=blank -maui'
       projectName: 'MauiBlank'
  - template: templates/package-validation.yml
    parameters:
       templateArgs: '-preset=recommended -maui'
       projectName: 'MauiRecommended'
  - template: templates/package-validation.yml
    parameters:
       templateArgs: '-preset=recommended -maui -tfm net8.0'
       projectName: 'MauiRecommendedNet8'

  - task: PublishBuildArtifacts@1
    condition: always()
    retryCountOnTaskFailure: 3
    inputs:
      PathtoPublish: $(build.artifactstagingdirectory)
      ArtifactName: logs
      ArtifactType: Container
